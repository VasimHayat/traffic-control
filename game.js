class Vector2{constructor(x=0,y=0){this.x=x;this.y=y;}add(other){return new Vector2(this.x+other.x,this.y+other.y);}subtract(other){return new Vector2(this.x-other.x,this.y-other.y);}multiply(scalar){return new Vector2(this.x*scalar,this.y*scalar);}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y);}normalize(){const mag=this.magnitude();if(mag===0)return new Vector2(0,0);return new Vector2(this.x/mag,this.y/mag);}distance(other){return this.subtract(other).magnitude();}}class Car{constructor(x,y,direction=0,roadIndex=0){this.position=new Vector2(x,y);this.direction=direction;this.velocity=2;this.maxVelocity=3;this.roadIndex=roadIndex;this.width=20;this.height=30;this.color=this.getRandomColor();this.isStopped=false;this.stopTimer=0;this.id=Math.random();}getRandomColor(){const colors=['#FF6B6B','#4ECDC4','#45B7D1','#FFA07A','#98D8C8','#F7DC6F'];return colors[Math.floor(Math.random()*colors.length)];}update(gameState){if(!this.isStopped){this.moveForward();}else{this.stopTimer--;if(this.stopTimer<=0){this.isStopped=false;}}this.checkTrafficLight(gameState);this.checkCarCollision(gameState);this.checkBounds(gameState);}moveForward(){const dirVectors=[new Vector2(1,0),new Vector2(0,1),new Vector2(-1,0),new Vector2(0,-1)];const movement=dirVectors[this.direction].multiply(this.velocity);this.position=this.position.add(movement);}checkTrafficLight(gameState){const stopDistance=40;gameState.trafficLights.forEach(light=>{if(!light.isGreen){const distance=this.position.distance(light.position);if(distance<stopDistance&&this.isApproachingLight(light)){this.isStopped=true;this.stopTimer=5;if(distance<30){const dirVectors=[new Vector2(1,0),new Vector2(0,1),new Vector2(-1,0),new Vector2(0,-1)];this.position=this.position.subtract(dirVectors[this.direction].multiply(this.velocity));}}}});}isApproachingLight(light){const dirVectors=[new Vector2(1,0),new Vector2(0,1),new Vector2(-1,0),new Vector2(0,-1)];const dirVector=dirVectors[this.direction];const toLightVector=light.position.subtract(this.position);return toLightVector.x*dirVector.x+toLightVector.y*dirVector.y>0;}checkCarCollision(gameState){const collisionDistance=35;gameState.cars.forEach(otherCar=>{if(otherCar.id!==this.id){const distance=this.position.distance(otherCar.position);if(distance<collisionDistance&&this.isSameDirection(otherCar)){this.isStopped=true;this.stopTimer=3;}}});}isSameDirection(otherCar){return this.direction===otherCar.direction;}checkBounds(gameState){const bounds=gameState.canvas.width+50;if(this.position.x>bounds||this.position.y>gameState.canvas.height+50||this.position.x<-50||this.position.y<-50){gameState.cars=gameState.cars.filter(car=>car.id!==this.id);}}draw(ctx){ctx.save();ctx.translate(this.position.x,this.position.y);const rotations=[0,Math.PI/2,Math.PI,Math.PI*1.5];ctx.rotate(rotations[this.direction]);ctx.fillStyle=this.color;ctx.fillRect(-this.width/2,-this.height/2,this.width,this.height);ctx.fillStyle='#87CEEB';ctx.fillRect(-this.width/2+2,-this.height/2+2,this.width-4,8);ctx.restore();}}class TrafficLight{constructor(x,y,direction=0){this.position=new Vector2(x,y);this.direction=direction;this.isGreen=true;this.greenDuration=120;this.redDuration=100;this.timer=this.greenDuration;this.size=15;}update(){this.timer--;if(this.isGreen&&this.timer<=0){this.isGreen=false;this.timer=this.redDuration;}else if(!this.isGreen&&this.timer<=0){this.isGreen=true;this.timer=this.greenDuration;}}draw(ctx){ctx.fillStyle='#333';ctx.fillRect(this.position.x-5,this.position.y-25,10,50);ctx.fillStyle=this.isGreen?'#00FF00':'#FF0000';ctx.beginPath();ctx.arc(this.position.x,this.position.y,this.size,0,Math.PI*2);ctx.fill();ctx.strokeStyle=this.isGreen?'rgba(0, 255, 0, 0.5)':'rgba(255, 0, 0, 0.5)';ctx.lineWidth=3;ctx.beginPath();ctx.arc(this.position.x,this.position.y,this.size+5,0,Math.PI*2);ctx.stroke();}}class RoadNetwork{constructor(canvas){this.canvas=canvas;this.horizontalRoads=[{y:150,lanes:2},{y:450,lanes:2}];this.verticalRoads=[{x:200,lanes:2},{x:500,lanes:2}];this.roadWidth=60;}draw(ctx){ctx.fillStyle='#444';this.horizontalRoads.forEach(road=>{ctx.fillRect(0,road.y-this.roadWidth/2,this.canvas.width,this.roadWidth);});this.verticalRoads.forEach(road=>{ctx.fillRect(road.x-this.roadWidth/2,0,this.roadWidth,this.canvas.height);});ctx.strokeStyle='#FFD700';ctx.lineWidth=2;ctx.setLineDash([20,10]);this.horizontalRoads.forEach(road=>{ctx.beginPath();ctx.moveTo(0,road.y);ctx.lineTo(this.canvas.width,road.y);ctx.stroke();});this.verticalRoads.forEach(road=>{ctx.beginPath();ctx.moveTo(road.x,0);ctx.lineTo(road.x,this.canvas.height);ctx.stroke();});ctx.setLineDash([]);}}class TrafficSimulator{constructor(canvasId){this.canvas=document.getElementById(canvasId);this.ctx=this.canvas.getContext('2d');this.canvas.width=window.innerWidth-320;this.canvas.height=window.innerHeight-40;this.gameState={canvas:this.canvas,cars:[],trafficLights:[],roadNetwork:new RoadNetwork(this.canvas),frameCount:0,totalCarsSpawned:0};this.setupTrafficLights();this.isRunning=true;this.lastSpawnTime=0;this.spawnInterval=30;this.setupEventListeners();this.run();}setupTrafficLights(){const intersections=[{x:200,y:150},{x:200,y:450},{x:500,y:150},{x:500,y:450}];intersections.forEach((intersection,index)=>{const light=new TrafficLight(intersection.x,intersection.y,index);this.gameState.trafficLights.push(light);});}setupEventListeners(){document.getElementById('pauseBtn').addEventListener('click',()=>{if(this.isRunning){this.pause();}else{this.resume();}});document.getElementById('resetBtn').addEventListener('click',()=>{this.reset();});window.addEventListener('keydown',(e)=>{if(e.code==='Space'){e.preventDefault();if(this.isRunning){this.pause();}else{this.resume();}}});window.addEventListener('resize',()=>{this.canvas.width=window.innerWidth-320;this.canvas.height=window.innerHeight-40;});}spawnCars(){this.lastSpawnTime++;if(this.lastSpawnTime>=this.spawnInterval){const spawnConfigs=[{x:-20,y:150,dir:0,road:0},{x:this.canvas.width+20,y:450,dir:2,road:1},{x:200,y:-20,dir:1,road:0},{x:500,y:this.canvas.height+20,dir:3,road:1}];const config=spawnConfigs[Math.floor(Math.random()*spawnConfigs.length)];const car=new Car(config.x,config.y,config.dir,config.road);this.gameState.cars.push(car);this.gameState.totalCarsSpawned++;this.lastSpawnTime=0;this.updateStats();}}update(){this.gameState.frameCount++;this.spawnCars();this.gameState.trafficLights.forEach(light=>light.update());this.gameState.cars.forEach(car=>car.update(this.gameState));}draw(){this.ctx.fillStyle='#1a1a1a';this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);this.gameState.roadNetwork.draw(this.ctx);this.gameState.trafficLights.forEach(light=>light.draw(this.ctx));this.gameState.cars.forEach(car=>car.draw(this.ctx));}updateStats(){document.getElementById('activeCars').textContent=this.gameState.cars.length;document.getElementById('totalCars').textContent=this.gameState.totalCarsSpawned;document.getElementById('simTime').textContent=Math.floor(this.gameState.frameCount/60);}run(){const gameLoop=()=>{if(this.isRunning){this.update();this.draw();}this.updateStats();requestAnimationFrame(gameLoop);};gameLoop();}pause(){this.isRunning=false;document.getElementById('pauseBtn').textContent='Resume (Space)';document.getElementById('status').textContent='Paused';}resume(){this.isRunning=true;document.getElementById('pauseBtn').textContent='Pause (Space)';document.getElementById('status').textContent='Running';}reset(){this.gameState.cars=[];this.gameState.totalCarsSpawned=0;this.gameState.frameCount=0;this.lastSpawnTime=0;this.updateStats();this.resume();}}window.addEventListener('DOMContentLoaded',()=>{new TrafficSimulator('gameCanvas');});